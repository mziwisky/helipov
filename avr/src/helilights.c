// helilights.c
// 
// A POV display for R/C helicopter blades.
//
// Part of the HeliPOV project.
// http://mziwisky.wordpress.com
//
// Written for the AVR ATmega128
//
// NOTE: fuses set to use 8MHz internal osc w/ no divide by 8.
// fuses:  e2 df f9
// The command to do this is:
// avrdude -c usbtiny -p atmega168 -P usb -U lfuse:w:0xe2:m -U hfuse:w:0xdf:m -U efuse:w:0xf9:m


#include <stdint.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>

#define SRCLK_DDR DDRB		//Shift Register Clock (on SPI pin SCK)
#define SRCLK_PORT PORTB
#define SRCLK_PIN PB5

#define SIN_DDR DDRB		//Serial data to shift registers (on SPI pin MOSI)
#define SIN_PORT PORTB
#define SIN_PIN PB3

#define LATCH_DDR DDRB		//Latch serial data to LEDs
#define LATCH_PORT PORTB
#define LATCH_PIN PB1

#define CLR_DDR DDRB		//Clear all register outputs
#define CLR_PORT PORTB		//NOTE: LO to clear.  HIGH normally.  After clearing, must latch
#define CLR_PIN PB2			//the zeros to the outputs!

#define ENABLE_DDR DDRD		//Enable all register outputs.
#define ENABLE_PORT PORTD	//LO: outputs on.  HI: outputs tri-stated (but values are
#define ENABLE_PIN PD5		//remembered so that they'll go back when this goes LO (I think)).

#define HALL_DDR DDRD		//Hall sensor input
#define HALL_PORT PORTD
#define HALL_PIN PIND
#define HALL_BIT PD3


#define setOutput(ddr, pin) ((ddr) |= (1 << (pin)))
#define setLow(port, pin) ((port) &= ~(1 << (pin)))
#define setHigh(port, pin) ((port) |= (1 << (pin)))
#define toggle(port, pin) ((port) ^= (1 << (pin)))
#define pulse(port, pin) do { \
							setHigh((port), (pin)); \
							setLow((port), (pin)); \
						} while (0)
#define outputState(port, pin) ((port) & (1 << (pin)))

volatile uint16_t period = 0xFFFF;	// Period of revolution, in PRESCALED (prescaler 8) timer ticks
volatile uint16_t sliceIndex = 0;	// Which slice to light up next.
volatile uint8_t flag = 0;			// Set when Timer0 CompA ISR is run

const uint8_t image[1024] PROGMEM = { // MU for top blade
0x5F,0xFF,0x00,0x2A,0x57,0xFF,0x00,0x2A,0x57,0xFF,0x00,0x2A,0x55,0xFF,0x00,0x2A,
0x55,0x55,0x00,0x2A,0x01,0x55,0x00,0x2A,0x00,0x05,0x00,0x2A,0x00,0x05,0x00,0x2A,
0x00,0x05,0x40,0x2A,0x00,0x05,0x00,0x2A,0x00,0x05,0x00,0xAA,0x00,0x05,0x00,0xAA,
0x00,0x05,0x00,0xA8,0x00,0x05,0x02,0xA8,0x00,0x15,0x02,0xA8,0x00,0x15,0x02,0xA0,
0x00,0x15,0x0A,0xA0,0x80,0x14,0xAA,0xA0,0xA0,0x14,0xAA,0x80,0xA8,0x14,0xAA,0x80,
0xAA,0x14,0xAA,0x80,0xAA,0x94,0xAA,0x80,0xAA,0xD4,0xAA,0x80,0xAA,0xF5,0x00,0x00,
0x2A,0xFD,0x00,0x00,0x2A,0xF9,0x00,0x00,0x8A,0xFB,0x80,0x00,0x2B,0xFA,0x80,0x00,
0x6B,0xDA,0x00,0x00,0xEB,0xDA,0x80,0x00,0xEB,0xDA,0x00,0x00,0xFF,0x4A,0x80,0x00,
0xFF,0x4A,0x80,0x00,0xFD,0x4B,0xA0,0x00,0xFD,0x0B,0xA0,0x00,0xF5,0x0B,0xA8,0x00,
0xF5,0x0B,0xAA,0x00,0xD5,0x07,0xAA,0x80,0x54,0x06,0xAA,0xA0,0x54,0x0E,0xAA,0xA0,
0x50,0x0E,0x2A,0xAA,0x40,0x2E,0x4A,0xAA,0x42,0xAE,0x4A,0xAA,0x0A,0xAE,0x2A,0xAA,
0xAB,0xAC,0xAA,0xA0,0xAF,0xA4,0xAA,0x80,0xAE,0x84,0xAB,0xC0,0xAC,0x05,0xFF,0xEA,
0x04,0x03,0xFF,0xEA,0x04,0x03,0x51,0xEA,0x04,0x83,0x01,0x40,0x95,0x83,0x01,0x40,
0xD5,0x83,0x09,0x42,0xFF,0x81,0x09,0xC2,0x63,0x83,0x09,0xE2,0x23,0x03,0x0B,0x62,
0x63,0x01,0x0A,0x5A,0x4F,0x03,0x0A,0x5A,0x5F,0x01,0x08,0x50,0x5D,0x00,0x01,0x50,
0x00,0x00,0x55,0x52,0x00,0x00,0x57,0xEA,0x80,0x00,0xFA,0xAA,0xAA,0x00,0xAA,0xA8,
0xAA,0xA8,0xAA,0x00,0xAA,0xAA,0xA8,0x00,0xFA,0xAA,0x00,0x00,0xFF,0xAA,0x80,0x00,
0xFD,0xFA,0x80,0x00,0xFD,0x5E,0x80,0x00,0xFD,0x55,0x80,0x00,0xBD,0x55,0x80,0x00,
0xBD,0x55,0x80,0x00,0xA5,0x55,0x80,0x00,0xA5,0x55,0x80,0x00,0xA5,0x55,0x80,0x00,
0xA5,0x55,0x80,0x00,0xB5,0x55,0xA0,0x00,0xB5,0x45,0xA0,0x00,0x95,0x45,0xA0,0x00,
0x95,0x01,0xA0,0x00,0x95,0x01,0xA8,0x00,0x95,0x01,0xA8,0x00,0x95,0x00,0xA8,0x00,
0x54,0x00,0xAA,0x00,0x54,0x00,0xAA,0x00,0x55,0x00,0xAA,0x00,0x55,0x00,0x2A,0x80,
0x55,0x40,0x2A,0x80,0x55,0x42,0x0A,0xA0,0x55,0x42,0x0A,0xA0,0x55,0x52,0x0A,0xAA,
0x55,0x5A,0x52,0xAA,0x55,0x5A,0x57,0xAA,0x55,0x5A,0x55,0xFA,0x55,0x7E,0x55,0x6A,
0x55,0x7E,0x55,0x00,0x55,0xFE,0x54,0x02,0x55,0xFE,0x50,0x0A,0x05,0x54,0x50,0x0A,
0x00,0x04,0x40,0x2A,0x00,0x05,0x00,0x2A,0x00,0x05,0x00,0xAA,0x00,0x05,0x00,0xA8,
0x00,0x05,0x02,0xA8,0x00,0x05,0x02,0xA0,0x00,0x05,0x0A,0xA0,0x00,0x05,0x0A,0x80,
0x00,0x05,0x0A,0x80,0x00,0x05,0x2A,0x80,0x00,0x05,0xAA,0x00,0xA0,0x15,0xAA,0x00,
0xA8,0x05,0xAA,0x00,0xAA,0x15,0xA8,0x00,0xAA,0x95,0xA8,0x00,0xAA,0xB5,0x80,0x00,
0xAA,0x95,0x00,0x00,0x2A,0x95,0x00,0x00,0x2A,0x95,0x00,0x00,0x2A,0x15,0x00,0x00,
0xAA,0x55,0x00,0x00,0xAA,0x55,0x00,0x00,0xA8,0x55,0x80,0x00,0xA8,0x55,0x80,0x00,
0xA9,0x55,0xA0,0x00,0xA1,0x55,0xA0,0x00,0xA1,0x55,0xA0,0x00,0x85,0x55,0xA0,0x00,
0x85,0x55,0xA0,0x00,0x85,0x55,0xA0,0x00,0x85,0x55,0xA0,0x00,0x95,0x55,0xA0,0x00,
0x95,0x55,0xA0,0x00,0xD5,0x55,0xA0,0x00,0x95,0x55,0xA0,0x00,0x80,0x55,0xA0,0x00,
0x80,0x15,0xA0,0x00,0x80,0x05,0xA0,0x00,0x80,0x01,0xA8,0x00,0x00,0x00,0xA8,0x00,
0x00,0x00,0xA8,0x00,0x00,0x00,0xA8,0x00,0x00,0x00,0xA8,0x00,0x00,0x00,0xA8,0x00,
0x00,0x00,0x2A,0x00,0x00,0x00,0x2A,0x00,0x00,0x00,0x2A,0x00,0x80,0x00,0x2A,0x80,
0xA8,0x00,0xAA,0x80,0xAA,0x00,0xAA,0x80,0xAA,0x80,0xAA,0xA0,0xAA,0x80,0xAA,0xA0,
0xAA,0xA0,0xAA,0xA8,0xAA,0xA0,0xAA,0x00,0x2A,0xA8,0x00,0x00,0x0A,0xAA,0x00,0x00,
0x02,0xAA,0x00,0x00,0x02,0xAA,0x00,0x00,0x40,0xAA,0x00,0x00,0x40,0xAA,0x00,0x00,
0x40,0x2A,0x00,0x00,0x50,0x2A,0x00,0x00,0x50,0x0A,0x00,0x00,0x50,0x0A,0x00,0x00,
0x54,0x0A,0x00,0x00,0x54,0x02,0x00,0x00,0x54,0x02,0x00,0x00,0x54,0x02,0x00,0x00,
0x54,0x02,0x00,0x00,0x55,0x0A,0x00,0x00,0x55,0x0A,0x00,0x00,0x55,0x2A,0x00,0x00,
0x55,0xAA,0x00,0x00,0x57,0xAA,0x00,0x00,0x5F,0xAB,0x00,0x00,0x6F,0xAB,0x00,0x00,
0xAF,0xEB,0x00,0x00,0xAF,0xED,0x80,0x00,0xAF,0xE5,0xA8,0x00,0xAF,0xD5,0xAA,0x00,
0xAF,0x55,0xAA,0x00,0xA5,0x55,0xA8,0x00,0x85,0x55,0xA8,0x00,0xA5,0x55,0xA0,0x00,
0xB5,0x55,0xA0,0x00,0xFD,0x55,0x80,0x00,0xFD,0x57,0x80,0x00,0xFD,0x5E,0x80,0x00,
0xFD,0xFA,0x00,0x00,0xFF,0xAA,0x00,0x00,0xFA,0xAA,0x00,0x00,0xAA,0xAA,0xA8,0x00,
0xAA,0xA8,0xAA,0x80,0xAA,0x00,0xAA,0xAA,0x00,0x00,0xFA,0xAA,0x00,0x00,0x55,0xEA,
0x00,0x00,0x55,0x54,0x27,0xFA,0x01,0x54,0xA7,0xFE,0xA8,0x50,0x81,0x74,0xC0,0xFA,
0x80,0x30,0x80,0xD0,0x80,0x30,0x80,0xF8,0x80,0x30,0x80,0xD0,0x01,0x30,0x81,0xD0,
0x01,0x70,0xC1,0xEA,0x01,0x70,0x01,0x50,0x00,0x70,0x01,0x40,0x00,0x10,0x5F,0xEA,
0x00,0x10,0xFF,0xEA,0xBC,0x10,0xFF,0xEA,0xAF,0x90,0xAA,0x40,0xAB,0xF0,0xA8,0x00,
0xAB,0xF8,0xA8,0x00,0x0A,0xFA,0xA8,0x00,0x40,0xBA,0xAA,0x00,0x50,0x2A,0xAA,0x00,
0x50,0x0A,0x2A,0x80,0x54,0x0A,0x2A,0x80,0x54,0x02,0x2A,0xA0,0x55,0x02,0x0A,0xA0,
0x55,0x02,0x0A,0xA8,0x55,0x02,0x02,0xA8,0x55,0x0A,0x42,0xAA,0x55,0x4A,0x55,0xAA,
0x45,0x6A,0x54,0x2A,0x45,0x6A,0x54,0x2A,0x41,0x7A,0x54,0x02,0x01,0xFA,0x54,0x00,
0x01,0xF0,0x54,0x00,0x02,0xF0,0x54,0x00,0x0A,0xF0,0x55,0x00,0x0A,0xF0,0x55,0x00,
0x2A,0xFC,0x55,0x00,0xAA,0xFC,0x15,0x00,0xAA,0xFC,0x15,0x00,0xAA,0xBC,0x15,0x00,
0xAA,0xBE,0x55,0x00,0xAA,0xBE,0xD5,0x00,0xAA,0xBE,0x54,0x02,0xAA,0xBE,0x54,0x02,
0xAA,0xBF,0x50,0x02,0xAA,0xBF,0x50,0x02,0x6A,0xBF,0x50,0x0A,0x6A,0xAF,0x50,0x0A,
0x6A,0xAF,0x40,0x0A,0x6A,0xAF,0x40,0x0A,0x6A,0xAF,0x40,0x2A,0x6A,0xAF,0x40,0x2A,
0x6A,0xBF,0x40,0x2A,0x4A,0xFF,0x00,0x2A,0x4A,0xFF,0x00,0x2A,0x4B,0xFF,0x00,0x2A,
0x4B,0xFF,0x00,0x2A,0x4F,0xFF,0x00,0x2A,0x4F,0xFF,0x00,0x2A,0x4F,0xFF,0x00,0x2A,
};
/*const uint8_t image[1024] PROGMEM = { // Golden Eagles for bottom blade
0x75,0x55,0x00,0x00,0x55,0x55,0x00,0x00,0x55,0x55,0x00,0x00,0x41,0x45,0x00,0x00,
0x60,0x01,0x00,0x00,0x60,0x01,0x00,0x00,0xE0,0x11,0x00,0x00,0xF5,0x41,0x00,0x00,
0xDD,0x41,0x00,0x00,0x92,0x01,0x00,0x00,0xB0,0x81,0x00,0x00,0x10,0x81,0x00,0x00,
0x82,0x05,0x00,0x00,0xA8,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0xAA,0x01,0x00,0x00,
0xA0,0x01,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0xA0,0x00,0x00,0x02,0x88,0x00,0x00,
0x1A,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0xF8,0x00,0x00,0x00,
0xC0,0x02,0x00,0x00,0xC0,0x03,0x00,0x00,0x44,0x19,0x00,0x00,0x44,0x79,0x00,0x02,
0x41,0x79,0x00,0x02,0x51,0x33,0x00,0x00,0x50,0x99,0x00,0x00,0x50,0xA0,0x00,0xA0,
0x56,0x20,0x00,0xA8,0x57,0x80,0x00,0x88,0x57,0x80,0x00,0x82,0x57,0x00,0x00,0x22,
0x5F,0x02,0x20,0x20,0x1D,0x02,0x88,0x0A,0x15,0x08,0x08,0x08,0x01,0x08,0x02,0x04,
0x00,0x08,0x02,0x14,0x04,0x48,0x00,0x81,0x15,0x4A,0x05,0x81,0x51,0x0A,0x81,0x00,
0x51,0x00,0x84,0x21,0x40,0x00,0x20,0x20,0x40,0x00,0x21,0x40,0x04,0x00,0x20,0x50,
0x04,0x00,0x08,0x10,0x10,0x00,0x20,0x04,0x10,0x00,0x00,0x04,0x40,0x00,0x00,0x10,
0x40,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,
0x40,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x10,0x00,0x00,0x00,
0x04,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x01,0x40,0x00,0x00,0x40,0x50,0x00,0x00,
0x50,0x14,0x00,0x00,0xD0,0x01,0x00,0x00,0x55,0x00,0x00,0x00,0x75,0x40,0x00,0x00,
0x5D,0x55,0x00,0x00,0x5D,0x54,0x00,0x00,0xD7,0x50,0x00,0x00,0xF5,0xC1,0x00,0x00,
0xFD,0x21,0x00,0x00,0xFF,0x0D,0x00,0x00,0xFE,0x97,0x00,0x00,0xFA,0xF5,0x00,0x0A,
0xEA,0xEF,0x00,0x20,0xA3,0xFF,0x02,0x02,0xAD,0xFB,0x02,0x2A,0xBF,0x5F,0x00,0x2A,
0xBE,0xD6,0x00,0x8A,0x7F,0xFD,0x00,0x00,0xDF,0xBF,0x00,0x20,0xD7,0xBF,0x00,0x08,
0xE5,0xFD,0x00,0x00,0xED,0x45,0x00,0x02,0xFF,0xD3,0x00,0x00,0xFF,0xF1,0x00,0x00,
0xFB,0xDC,0x00,0x00,0x7B,0x74,0x00,0x00,0x54,0x55,0x00,0x00,0xD4,0xD5,0x00,0x00,
0xF4,0x55,0x00,0x00,0xF7,0x15,0x00,0x00,0xDD,0x05,0x00,0x00,0x1D,0x45,0x00,0x00,
0x35,0x40,0x00,0x00,0x15,0x50,0x00,0x00,0xC5,0x50,0x00,0x00,0xC5,0x50,0x00,0x00,
0xE5,0x50,0x00,0x00,0x49,0x40,0x00,0x00,0x52,0x45,0x00,0x00,0x70,0x85,0x00,0x00,
0x7C,0x35,0x00,0x00,0xFE,0x1C,0x00,0x00,0xFE,0xD6,0x00,0x00,0x7E,0xF1,0x00,0x0A,
0xDB,0xFB,0x00,0x20,0xF3,0xEF,0x02,0x02,0xF9,0xEB,0x20,0x2A,0xAB,0x3E,0x08,0xAA,
0xAF,0x97,0x00,0xAA,0x2E,0xBD,0x02,0x2A,0x9E,0xFF,0x00,0x80,0xB5,0xEF,0x00,0x22,
0xB9,0x7F,0x00,0x22,0xBB,0x53,0x00,0x08,0xBF,0xD4,0x00,0x00,0x6F,0xFD,0x00,0x02,
0x4E,0xF7,0x00,0x00,0xC7,0xD5,0x00,0x00,0xB5,0x15,0x00,0x00,0xBF,0x65,0x00,0x00,
0xBD,0xD1,0x00,0x00,0xB5,0xD0,0x00,0x00,0x47,0x54,0x00,0x00,0x51,0x55,0x00,0x00,
0xDC,0x55,0x00,0x00,0x74,0x55,0x00,0x00,0x75,0x15,0x00,0x00,0x55,0x40,0x00,0x00,
0xD5,0x40,0x00,0x00,0x55,0x50,0x00,0x00,0x15,0x51,0x00,0x00,0x15,0x40,0x00,0x00,
0x41,0x44,0x00,0x00,0x50,0x04,0x00,0x00,0x54,0x00,0x00,0x00,0x55,0x10,0x00,0x00,
0x55,0x10,0x00,0x00,0x54,0x00,0x00,0x00,0x54,0x40,0x00,0x00,0x54,0x40,0x00,0x00,
0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x41,0x00,0x00,0x00,0x51,0x00,0x00,0x00,
0x50,0x00,0x00,0x00,0xEB,0x55,0x00,0x00,0x45,0x40,0x00,0x00,0x44,0x00,0x00,0x00,
0xC8,0x05,0x00,0x00,0x88,0x15,0x00,0x00,0x81,0x55,0x00,0x00,0x01,0x54,0x00,0x00,
0xA5,0x50,0x00,0x00,0x25,0x45,0x00,0x00,0x35,0x15,0x00,0x00,0x14,0x55,0x00,0x00,
0x15,0x54,0x00,0x00,0x51,0x51,0x00,0x00,0xD5,0x45,0x00,0x00,0xD5,0x15,0x00,0x00,
0xD5,0x14,0x00,0x00,0xD4,0x54,0x00,0x00,0xD5,0x50,0x00,0x00,0x55,0x44,0x00,0x00,
0x51,0x54,0x00,0x00,0x55,0x14,0x00,0x00,0x55,0x54,0x00,0x14,0x55,0x51,0x00,0x44,
0x54,0x51,0x28,0x40,0x55,0x44,0x23,0x00,0x55,0x44,0x81,0x00,0x55,0x10,0x89,0x10,
0x51,0x10,0x8C,0x60,0x55,0x00,0x0C,0x61,0x55,0x48,0x25,0x81,0x54,0x68,0x21,0x84,
0x54,0x62,0x80,0x84,0x44,0x22,0x82,0x04,0x54,0x20,0x02,0x01,0x5D,0x08,0x08,0x02,
0x5D,0x08,0x08,0x02,0x7B,0x08,0x20,0x08,0x53,0x52,0x08,0x08,0x53,0x52,0x00,0x20,
0x51,0x90,0x00,0x82,0x50,0xA0,0x00,0x88,0x50,0x21,0x00,0x28,0xD0,0xA9,0x00,0x20,
0xD1,0xC9,0x00,0x00,0xF5,0x42,0x00,0x00,0xF4,0x46,0x00,0x02,0xFC,0x44,0x00,0x02,
0x7C,0x07,0x00,0x00,0x7E,0x01,0x00,0x00,0xFE,0x81,0x00,0x00,0xDC,0xA0,0x00,0x00,
0xFE,0x20,0x00,0x00,0x7F,0x08,0x00,0x00,0x5F,0x90,0x00,0x00,0x57,0xB0,0x00,0x00,
0x55,0xB0,0x00,0x00,0x55,0x70,0x00,0x00,0x55,0x40,0x00,0x00,0x55,0x40,0x00,0x00,
0x55,0x44,0x00,0x00,0x55,0x04,0x00,0x00,0x55,0x04,0x00,0x00,0x55,0x10,0x00,0x00,
0xD5,0x00,0x00,0x00,0xD5,0x01,0x00,0x00,0x75,0x51,0x00,0x00,0x5D,0x51,0x00,0x00,
0xD7,0x40,0x00,0x00,0xF5,0xD0,0x00,0x00,0xD7,0x50,0x00,0x00,0x5D,0x55,0x00,0x00,	
};*/

void init(void) {
	// Define outputs
	setOutput(SRCLK_DDR, SRCLK_PIN);
	setOutput(SIN_DDR, SIN_PIN);
	setOutput(LATCH_DDR, LATCH_PIN);
	setOutput(CLR_DDR, CLR_PIN);
	setOutput(ENABLE_DDR, ENABLE_PIN);

	// Clear the shift registers
	setLow(CLR_PORT, CLR_PIN);
	setHigh(CLR_PORT, CLR_PIN);
	pulse(LATCH_PORT, LATCH_PIN);

	// Enable shift registers
	setLow(ENABLE_PORT, ENABLE_PIN);
	
	// Enable external interrupt INT1
	EIMSK |= (1 << INT1);
	// Trigger INT1 on falling edge (This may require an I/O clock... p.65)
	EICRA |= (1 << ISC11);
	
	// Enable Timer0 (8-bit) Output Compare Match A Interrupt
	// NOTE: commented out because this interrupt will only be enabled once the blades
	// are up to ~1000RPM or higher.
	//TIMSK0 |= (1 << OCIE0A);
	
	// Set Timer0 (8-bit) CTC (clear on timer compare match) mode -- so above interrupt is thrown
	// when timer reaches whatever is in register OCR0A
	TCCR0A |= (1 << WGM01);
	OCR0A = 255;
	
	// Enable SPI, Master, data order: MSB first, leading edge is falling, set up on leading edge.
	SPCR |= ((1 << SPE) | (1 << MSTR) | (0 << DORD) | (1 << CPOL) | (1 << CPHA));
	
	// Set SPI clock rate to FCPU/2.
	SPSR |= (1 << SPI2X);
	
	// Enable global interrupts
	sei();

	// Start both timers at FCPU/8
	TCCR0B |= (1 << CS01);
	TCCR1B |= (1 << CS11);

}

int main(void) {
	init();
	
	for(;;) {}		// Loop forever.  Note -- could do power-saving stuff?
}


ISR(INT1_vect) {	// This fires when the Hall sensor is triggered
	// check Timer1 overflow flag -- if it has occurred, the blades are going too slow.  Clear it, and don't set period yet.
	if (TIFR1 & (1 << TOV1)){ // True if blades are slower than ~16 rev/sec
		// Reset Timer1
		TCNT1 = 0;
		// Turn off Timer0 CTC interrupt
		TIMSK0 &= ~(1 << OCIE0A);
		// Clear blades
		setLow(CLR_PORT, CLR_PIN);
		setHigh(CLR_PORT, CLR_PIN);
		pulse(LATCH_PORT, LATCH_PIN);
		// TODO:  Do some preset pattern instead of just turning the lights off.
		
		// Clear flag (writing 1 to it clears it)
		TIFR1 |= (1 << TOV1);
	}
	else {
		TIMSK0 |= (1 << OCIE0A);
		// Use last 5 Timer1 values to calculate average period
		// Really, new period is (4/5)*oldTimer1 + (1/5)*newTimer1
		//period = (period/5)*4 + TCNT1/5;
		period = TCNT1;	//No averaging
		
		// Reset Timer1
		TCNT1 = 0;
		
		// Set CTC compare register according to RPM -- period/256
		uint8_t tmp = period/256;
		OCR0A = tmp;
		
		// Start indexing variable back at 0
		sliceIndex = 0;
		
		TCNT0 = tmp-1;
	}
	
}

ISR(TIMER0_COMPA_vect) {	// This fires when Timer0 reaches the value in OCR0A
	// Latch the buffered outputs
	pulse(LATCH_PORT, LATCH_PIN);
	
	// Feed the four image bytes beginning at sliceIndex to the registers
	SPDR = pgm_read_byte(&image[sliceIndex++]);		// Start transmitting byte 0
	while (!(SPSR & (1 << SPIF)));					// Wait for transmission to complete
	SPDR = pgm_read_byte(&image[sliceIndex++]);		// Start transmitting byte 1
	while (!(SPSR & (1 << SPIF)));					// Wait for transmission to complete
	SPDR = pgm_read_byte(&image[sliceIndex++]);		// Start transmitting byte 2
	while (!(SPSR & (1 << SPIF)));					// Wait for transmission to complete
	SPDR = pgm_read_byte(&image[sliceIndex++]);		// Start transmitting byte 3
	if (sliceIndex >= 1024)
		sliceIndex=0;
	while (!(SPSR & (1 << SPIF)));					// Wait for transmission to complete
}
